#include<pic18f25k22.h>
#include <xc.h>
#include<stdint.h>

#define _XTAL_FREQ 16000000   // delay????(????16MHz???)

#pragma config PRICLKEN=OFF,PLLCFG=OFF,FOSC=INTIO67    // CONFIG1H
#pragma config BOREN=NOSLP,BORV=285,PWRTEN=ON          // CONFIG2L
#pragma config WDTEN=OFF                               // CONFIG2H
#pragma config MCLRE=INTMCLR,HFOFST=OFF                // CONFIG3H
#pragma config LVP=OFF                                 // CONFIG4L

typedef struct{
    uint8_t high;
    uint16_t low;
} image_data;

typedef struct{
    image_data dat[8];
} num_data;

image_data screen[90];

num_data number_font[11]={
{{
	{0b00000111,0b1100000000000000},
	{0b00001000,0b1010000000000000},
	{0b00001001,0b0010000000000000},
	{0b00001010,0b0010000000000000},
	{0b00000111,0b1100000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000}
}},

{{
	{0b00000010,0b0010000000000000},
	{0b00000100,0b0010000000000000},
	{0b00001111,0b1110000000000000},
	{0b00000000,0b0010000000000000},
	{0b00000000,0b0010000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000}
}},

{{
	{0b00000100,0b0110000000000000},
	{0b00001000,0b0110000000000000},
	{0b00001000,0b1010000000000000},
	{0b00001000,0b1010000000000000},
	{0b00000111,0b0010000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000}
}},

{{
	{0b00000100,0b0100000000000000},
	{0b00001000,0b0010000000000000},
	{0b00001001,0b0010000000000000},
	{0b00001001,0b0010000000000000},
	{0b00000110,0b1100000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000}
}},

{{
	{0b00000011,0b1100000000000000},
	{0b00000100,0b0100000000000000},
	{0b00001000,0b0100000000000000},
	{0b00001111,0b1110000000000000},
	{0b00000000,0b0100000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000}
}},

{{
	{0b00001110,0b0100000000000000},
	{0b00001010,0b0010000000000000},
	{0b00001010,0b0010000000000000},
	{0b00001010,0b0010000000000000},
	{0b00001001,0b1100000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000}
}},

{{
	{0b00000111,0b1100000000000000},
	{0b00001010,0b0010000000000000},
	{0b00001010,0b0010000000000000},
	{0b00001010,0b0010000000000000},
	{0b00000001,0b1100000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000}
}},

{{
	{0b00001100,0b0000000000000000},
	{0b00001000,0b0000000000000000},
	{0b00001000,0b0110000000000000},
	{0b00001001,0b1000000000000000},
	{0b00001110,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000}
}},

{{
	{0b00000110,0b1100000000000000},
	{0b00001001,0b0010000000000000},
	{0b00001001,0b0010000000000000},
	{0b00001001,0b0010000000000000},
	{0b00000110,0b1100000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000}
}},

{{
	{0b00000111,0b0000000000000000},
	{0b00001000,0b1010000000000000},
	{0b00001000,0b1010000000000000},
	{0b00001000,0b1010000000000000},
	{0b00000111,0b1100000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000}
}},

{{
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000010,0b0100000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000}
 }}
};

image_data ThankYou[90] = {
    {0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
    	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
{0b00001000,0b0000000000000000},
	{0b00001000,0b0000000000000000},
	{0b00001111,0b1110000000000000},
	{0b00001000,0b0000000000000000},
	{0b00001000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
{0b00001111,0b1110000000000000},
	{0b00000001,0b0000000000000000},
	{0b00000010,0b0000000000000000},
	{0b00000010,0b0000000000000000},
	{0b00000001,0b1110000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0100000000000000},
	{0b00000010,0b1010000000000000},
	{0b00000010,0b1010000000000000},
	{0b00000010,0b1010000000000000},
	{0b00000001,0b1100000000000000},
	{0b00000000,0b0010000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
{0b00000011,0b1110000000000000},
	{0b00000010,0b0000000000000000},
	{0b00000010,0b0000000000000000},
	{0b00000010,0b0000000000000000},
	{0b00000001,0b1110000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00001111,0b1110000000000000},
	{0b00000000,0b1000000000000000},
	{0b00000001,0b0100000000000000},
	{0b00000010,0b0010000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
{0b00001100,0b0000000000000000},
	{0b00000010,0b0000000000000000},
	{0b00000001,0b1110000000000000},
	{0b00000010,0b0000000000000000},
	{0b00001100,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
{0b00000001,0b1100000000000000},
	{0b00000010,0b0010000000000000},
	{0b00000010,0b0010000000000000},
	{0b00000010,0b0010000000000000},
	{0b00000001,0b1100000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
{0b00000011,0b0000000000000000},
	{0b00000000,0b1100000000000000},
	{0b00000000,0b0010000000000000},
	{0b00000000,0b1100000000000000},
	{0b00000011,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000},
	{0b00001111,0b1010000000000000},
	{0b00000000,0b0000000000000000},
	{0b00000000,0b0000000000000000}	
};

image_data Youkoso[90] = {
    {0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000111,0b1110000000000000},
{0b00000100,0b0010000000000000},
{0b00000100,0b0010000000000000},
{0b00000100,0b0010000000000000},
{0b00000100,0b0010000000000000},
{0b00000111,0b1110000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000100,0b1000000000000000},
{0b00000100,0b1000000000000000},
{0b00000100,0b1000000000000000},
{0b00001111,0b1110000000000000},
{0b00000100,0b1000000000000000},
{0b00000100,0b1000000000000000},
{0b00000100,0b1000000000000000},
{0b00000000,0b0000000000000000},
{0b00000100,0b0000000000000000},
{0b00000010,0b0000000000000000},
{0b00001000,0b0000000000000000},
{0b00000100,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000010,0b0000000000000000},
{0b00001100,0b0010000000000000},
{0b00000100,0b0010000000000000},
{0b00000100,0b0010000000000000},
{0b00000111,0b1100000000000000},
{0b00000100,0b0000000000000000},
{0b00000100,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000100,0b0010000000000000},
{0b00000010,0b0010000000000000},
{0b00000001,0b0010000000000000},
{0b00000000,0b0010000000000000},
{0b00000000,0b0100000000000000},
{0b00000000,0b1000000000000000},
{0b00000111,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b1000000000000000},
{0b00000001,0b0000000000000000},
{0b00000010,0b0000000000000000},
{0b00000001,0b0000000000000000},
{0b00000000,0b1000000000000000},
{0b00000000,0b0100000000000000},
{0b00000000,0b0010000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000101,0b0010000000000000},
{0b00000101,0b0010000000000000},
{0b00000101,0b0010000000000000},
{0b00000101,0b0010000000000000},
{0b00000111,0b1110000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000111,0b0000000000000000},
{0b00000100,0b0000000000000000},
{0b00000100,0b0010000000000000},
{0b00001100,0b0010000000000000},
{0b00000100,0b0010000000000000},
{0b00000100,0b1100000000000000},
{0b00000111,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000100,0b0010000000000000},
{0b00000100,0b0010000000000000},
{0b00000100,0b0010000000000000},
{0b00000100,0b0010000000000000},
{0b00000100,0b0010000000000000},
{0b00000111,0b1110000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00001100,0b0000000000000000},
{0b00000011,0b0000000000000000},
{0b00000000,0b0010000000000000},
{0b00000000,0b0010000000000000},
{0b00000000,0b1100000000000000},
{0b00001111,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000},
{0b00000000,0b0000000000000000}
};

enum {
    Off,
    Red,
    Blue,
    Purple,
    Green,
    Yellow,
    Aqua,
    White
};

const uint16_t S = 90;
uint16_t count;
const uint32_t time_control_count = 3036;
const uint32_t N = (65535-time_control_count)*8;
uint8_t eight_count;
uint32_t light_interval = 1000;
uint32_t light_point = 0;
uint16_t color_count;
int16_t time_count = 20;

void light(unsigned char c,unsigned char h,unsigned int l) {
    LATBbits.LATB5 = (c>>0) & 1 ; 
    LATBbits.LATB6 = (c>>1) & 1 ; 
    LATBbits.LATB7 = (c>>2) & 1 ; 

    LATBbits.LATB0 = (h>>0) & 1 ; 
    LATBbits.LATB1 = (h>>1) & 1 ; 
    LATBbits.LATB2 = (h>>2) & 1 ; 
    LATBbits.LATB3 = (h>>3) & 1 ;
    LATC = l>>8;
    LATA = l;
}


void Wait(unsigned int num){
     for (;num; num--)  __delay_ms(1) ; 
}

void main(){
    OSCCON = 0b01110010 ;    // 16MHz
    ANSELA = 0b00000000 ;    // AN0-4 ???????????????I/O???
    ANSELB = 0b00000000 ;    // AN8-13???????????????I/O???
    ANSELC = 0b00000000 ;    // AN14-19???????????????I/O???
    TRISA  = 0b00000000 ;    // RA0-RA7????????1??? 0???
    TRISB  = 0b00010000 ;    // RB0-RB7???????
    TRISC  = 0b00000000 ;    // RC0-RC7??????? 
    PORTA  = 0b00000000 ;    // ????????(??LOW???)
    PORTB  = 0b00000000 ;    // ????????(??LOW???)
    PORTC  = 0b00000000 ;    // ????????(??LOW???)
    
    
    T1CON  = 0b00110011;
    TMR1H  = time_control_count >> 8 ;
    TMR1L  = time_control_count & 0x00ff ;
    TMR1IF = 0 ;
    TMR1IE = 1;
    
    T3CON  = 0b00110011;
    TMR3H  = (65535-light_interval) >> 8 ;
    TMR3L  = (65535-light_interval) & 0x00ff ;
    TMR3IF = 0 ;
    TMR3IE = 1;
    
    PEIE = 1;
    GIE = 1;
    
    light(0,0,0);
    
    
    char prev = 0;
    while(1) {
        
        if(PORTBbits.RB4 == 1 && prev == 0){    //positive edge
            count++;
            prev = 1;
            light_point = 0;
        }
        if(PORTBbits.RB4 == 0 && prev == 1){    //negative edge
            prev=0;
        }
        
        //light(Aqua,0,count);
        //Wait(1);
    }
}

uint8_t get_color(uint32_t x){
    if(5<=x && x<=12){
        return Red;
    }else if(13<=x && x<=26){
        return Green;
    }else if(27<=x && x<=34){
        return Blue;
    }else if(36<=x && x<=42){
        return Yellow;
    }else if(44<=x && x<=51){
        return Purple;
    }else if(52<=x && x<=58){
        return Aqua;
    }else if(59<=x && x<=66){
        return White;
    }else if(68<=x && x<=74){
        return Green;
    }else if(76<=x && x<=83){
        return Yellow;
    }
    
    return Off;
}

char min;
char sec;
char letter_start = 0;
char numlist[5] = {0,0,10,0,0};
char co=0;
void interrupt timer(void){
    if(TMR1IF){
        TMR1H = 0;
        TMR1L = 0;
        TMR1IF = 0;
        
        eight_count++;
        if(eight_count==8){
            light_interval = count ? 65535 - (N/(count*S) + N/(count*S+S))/2 : light_interval;
            count = 0;
            eight_count=0;
            color_count++;
            if(color_count > 14) time_count--;
            if(time_count>=0){
                min = time_count/60;
                sec = time_count%60;
                numlist[0] = min/10;
                numlist[1] = min%10;
                numlist[3] = sec/10;          
                numlist[4] = sec%10;
            
                for(int i=0;i<5;i++){
                    for(int j=0;j<8;j++) screen[j+i*8+27] = number_font[numlist[i]].dat[j];
                }
            }
        }
    }
    
    static char v=0;
    if(TMR3IF){
        TMR3H =  light_interval >> 8;
        TMR3L =  light_interval & 0x00ff;
        TMR3IF = 0;
        if(light_point<S){
            /*if(light_point==30) letter_start = 1;
            if(light_point==30+8*5+1) letter_start = 0;
            if(letter_start == 1){
                light(Blue,number_font[numlist[(light_point-30)/8]].dat[co].high,number_font[numlist[(light_point-30)/8]].dat[co].low);
                co++;
                if(co==8) co=0;
            }*/
            if(color_count<=12) light(get_color(light_point),Youkoso[light_point].high,Youkoso[light_point].low);
            else if(time_count>=0){
                light(time_count/10%7+1,screen[light_point].high,screen[light_point].low);
            }
            else{
                if(-time_count /8 %2 == 0) light(color_count%7+1,ThankYou[light_point].high,ThankYou[light_point].low);
                else light(get_color(light_point),Youkoso[light_point].high,Youkoso[light_point].low);
            }
        }
        
        light_point++;
    }
}
